//@version=5
indicator("3XC", overlay=true)

// === INPUTS ===
fastEmaLen  = input.int(9, "Fast EMA")
midEmaLen   = input.int(21, "Mid EMA")
slowEmaLen  = input.int(50, "Slow EMA")

rsiLen      = input.int(14, "RSI Length")
stochKLen   = input.int(14, "Stoch %K Length")
stochDLen   = input.int(3, "Stoch %D Smoothing")
stochSmooth = input.int(3, "Stoch K Smoothing")

macdFast    = input.int(12, "MACD Fast")
macdSlow    = input.int(26, "MACD Slow")
macdSig     = input.int(9, "MACD Signal")

showFVG     = input.bool(true, "Enable FVG Detection")
showBox     = input.bool(true, "Draw London Session Box")

// === EMA Trend ===
emaFast = ta.ema(close, fastEmaLen)
emaMid  = ta.ema(close, midEmaLen)
emaSlow = ta.ema(close, slowEmaLen)

uptrend   = emaFast > emaMid and emaMid > emaSlow
downtrend = emaFast < emaMid and emaMid < emaSlow

plot(emaFast, color=color.orange, title="Fast EMA")
plot(emaMid, color=color.blue, title="Mid EMA")
plot(emaSlow, color=color.purple, title="Slow EMA")

// === RSI & Stochastics ===
rsi     = ta.rsi(close, rsiLen)
rsiBull = rsi > 40 and rsi < 70
rsiBear = rsi < 60 and rsi > 30

k = ta.sma(ta.stoch(close, high, low, stochKLen), stochSmooth)
d = ta.sma(k, stochDLen)
stochBull = k < 20 and ta.crossover(k, d)
stochBear = k > 80 and ta.crossunder(k, d)

// === MACD Triple Stack ===
[macdLine, signalLine, _] = ta.macd(close, macdFast, macdSlow, macdSig)
macdBull = macdLine > signalLine and macdLine > 0 and signalLine > 0
macdBear = macdLine < signalLine and macdLine < 0 and signalLine < 0

// === Volume Spike / Fakeout Filter ===
volSpike = volume > ta.sma(volume, 20) * 1.5

// === Fair Value Gap Detection ===
fvgBullFound = low[1] > high[2]
fvgBearFound = high[1] < low[2]

if showFVG and fvgBullFound
    box.new(left=bar_index[2], right=bar_index, top=high[2], bottom=low[1], border_color=na, bgcolor=color.new(color.green, 80))

if showFVG and fvgBearFound
    box.new(left=bar_index[2], right=bar_index, top=high[1], bottom=low[2], border_color=na, bgcolor=color.new(color.red, 80))

// === London Session Box ===
londonSess   = "0200-0500" // Typically in UTC
inLondon     = not na(time(timeframe.period, londonSess))
startLondon  = inLondon and not inLondon[1]

var box londonBox = na

if showBox
    if startLondon
        londonBox := box.new(left=bar_index, top=high, bottom=low, right=bar_index, bgcolor=color.new(color.gray, 90), border_color=color.gray)
    if inLondon
        box.set_right(londonBox, bar_index + 1)
        box.set_top(londonBox, math.max(box.get_top(londonBox), high))
        box.set_bottom(londonBox, math.min(box.get_bottom(londonBox), low))

// === Confluence Entry Conditions ===
longSignal  = uptrend and rsiBull and stochBull and macdBull and volSpike and fvgBullFound
shortSignal = downtrend and rsiBear and stochBear and macdBear and volSpike and fvgBearFound

// === Alerts ===
if longSignal
    alert("LONG Setup Triggered", alert.freq_once_per_bar)

if shortSignal
    alert("SHORT Setup Triggered", alert.freq_once_per_bar)

// === Visual Entry Markers ===
plotshape(longSignal, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Long Entry")
plotshape(shortSignal, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="Short Entry")
